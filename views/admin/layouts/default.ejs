<!doctype html>
<html lang="en">
<head><%- include('../parts/head.ejs') %></head>
<body>
    <!-- Navbar -->
    <%- include('../parts/navbar.ejs') %>
    <!-- Sidebar -->
    <%- include('../parts/sidebar.ejs') %>
    
    <!-- Main Content -->
    <main class="main-content bg-light">
        <section id="dashboard" class="p-4">
            <div class="page-header mb-4 d-flex justify-content-between align-items-end">
                <div>
                    <h1 class="page-title fw-bold text-dark">Ուսանողների Առաջընթացի </h1>
                    <p class="text-muted mb-0">Դիտեք ուսանողների աճի դինամիկան և ռիսկային խմբերը</p>
                </div>
                <form class="d-flex gap-2" method="GET" action="">
                    <div>
                        <label class="form-label small text-muted mb-1">Սկիզբ</label>
                        <input type="date" class="form-control form-control-sm" name="startDate" value="<%= filters.startDate %>" onchange="this.form.submit()">
                    </div>
                    <div>
                        <label class="form-label small text-muted mb-1">Ավարտ</label>
                        <input type="date" class="form-control form-control-sm" name="endDate" value="<%= filters.endDate %>" onchange="this.form.submit()">
                    </div>
                </form>
            </div>

            <!-- KPI Cards -->
            <div class="row g-4 mb-5">
                <div class="col-md-6 col-xl-3">
                    <div class="card border-0 shadow-sm h-100 rounded-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i class="bi bi-people fs-4"></i>
                                </div>
                                <span class="badge bg-light text-muted border">Ընդհանուր</span>
                            </div>
                            <h2 class="fw-bold mb-1"><%= kpi.totalStudents %></h2>
                            <div class="text-muted small">Գրանցված ուսանողներ</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card border-0 shadow-sm h-100 rounded-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="icon-box bg-info bg-opacity-10 text-info rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i class="bi bi-graph-up-arrow fs-4"></i>
                                </div>
                                <span class="badge bg-light text-muted border">30 օր</span>
                            </div>
                            <h2 class="fw-bold mb-1 <%= kpi.avgGrowth >= 0 ? 'text-success' : 'text-danger' %>">
                                <%= kpi.avgGrowth > 0 ? '+' : '' %><%= kpi.avgGrowth %>
                            </h2>
                            <div class="text-muted small">Միջին միավորի աճ</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card border-0 shadow-sm h-100 rounded-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i class="bi bi-person-check fs-4"></i>
                                </div>
                                <span class="badge bg-success-subtle text-success border border-success-subtle">Լավագույն</span>
                            </div>
                            <h2 class="fw-bold mb-1"><%= kpi.improving %></h2>
                            <div class="text-muted small">Բարելավվող ուսանողներ</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-xl-3">
                    <div class="card border-0 shadow-sm h-100 rounded-4">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <div class="icon-box bg-danger bg-opacity-10 text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                    <i class="bi bi-exclamation-triangle fs-4"></i>
                                </div>
                                <span class="badge bg-danger-subtle text-danger border border-danger-subtle">Ուշադրություն</span>
                            </div>
                            <h2 class="fw-bold mb-1"><%= kpi.risk %></h2>
                            <div class="text-muted small">Ռիսկային խմբում</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="row g-4 mb-5">
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0">
                            <h5 class="fw-bold mb-0">Միջին Միավորի Դինամիկա</h5>
                            <p class="text-muted small">Ըստ ուսանողների կարգավիճակի</p>
                        </div>
                        <div class="card-body p-4">
                            <!-- Custom Legend -->
                            <div id="growthLegend" class="d-flex gap-2 justify-content-end mb-3"></div>
                            
                            <div style="position: relative; height: 300px; width: 100%;">
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm rounded-4 h-100">
                        <div class="card-header bg-transparent border-0 pt-4 px-4 pb-0">
                            <h5 class="fw-bold mb-0">Սեգմենտավորում</h5>
                        </div>
                        <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
                            <div style="position: relative; height: 250px; width: 100%; display: flex; justify-content: center;">
                                <div style="width: 200px; height: 200px;">
                                    <canvas id="statusChart"></canvas>
                                </div>
                            </div>
                            <div class="mt-4 w-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-success me-2 p-1"> </span>Բարելավվող</span>
                                    <span class="fw-bold"><%= kpi.improving %></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-warning me-2 p-1"> </span>Կայուն</span>
                                    <span class="fw-bold"><%= kpi.stagnant %></span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="d-flex align-items-center"><span class="badge rounded-circle bg-danger me-2 p-1"> </span>Ռիսկային</span>
                                    <span class="fw-bold"><%= kpi.risk %></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Students Table -->
            <div class="card border-0 shadow-sm rounded-4">
                <div class="card-header bg-transparent border-0 pt-4 px-4 pb-2 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div class="d-flex align-items-center">
                        <h5 class="fw-bold mb-0">Ուսանողների Ցանկ</h5>
                        <span class="badge bg-primary rounded-pill ms-2" style="font-size: 0.75rem;"><%= pagination.totalItems %></span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button id="disableAllAnalytics" class="btn btn-sm btn-outline-danger border d-flex align-items-center gap-2" style="border-radius: 10px;" title="Անջատել բոլորի անալիտիկան">
                            <i class="bi bi-toggle-off"></i>
                            <span class="d-none d-lg-inline">Անջատել Բոլորը</span>
                        </button>
                        <div class="position-relative" style="width: 300px;">
                            <i class="bi bi-search text-muted position-absolute top-50 start-0 translate-middle-y ms-3"></i>
                            <input type="text" id="studentSearch" class="form-control form-control-sm ps-5 border" style="border-radius: 10px;" placeholder="Որոնել ուսանողին..." value="<%= filters.search %>">
                        </div>
                        <select id="statusFilter" class="form-select form-select-sm" style="max-width: 150px; border-radius: 10px;">
                            <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>Բոլորը</option>
                            <option value="improving" <%= filters.status === 'improving' ? 'selected' : '' %>>Բարելավվող</option>
                            <option value="stagnant" <%= filters.status === 'stagnant' ? 'selected' : '' %>>Կայուն</option>
                            <option value="risk" <%= filters.status === 'risk' ? 'selected' : '' %>>Ռիսկային</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" style="border-collapse: separate; border-spacing: 0;">
                            <thead class="bg-light">
                                <tr>
                                    <th class="ps-4 py-3 border-bottom-0 text-muted small text-uppercase">Ուսանող</th>
                                    <th class="py-3 border-bottom-0 text-muted small text-uppercase">Փորձեր</th>
                                    <th class="py-3 border-bottom-0 text-muted small text-uppercase">Վերջին Միավոր</th>
                                    <th class="py-3 border-bottom-0 text-muted small text-uppercase">Աճի Դինամիկա</th>
                                    <th class="py-3 border-bottom-0 text-muted small text-uppercase">Կարգավիճակ</th>
                                    <th class="py-3 border-bottom-0 text-muted small text-uppercase">Անալիտիկա</th>
                                    <th class="pe-4 py-3 border-bottom-0 text-end text-muted small text-uppercase">Գործողություն</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% students.forEach((student, index) => { %>
                                    <tr class="align-middle">
                                        <td class="ps-4 py-3">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-initial rounded-circle bg-light text-primary fw-bold me-3" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                                    <%= student.name.charAt(0).toUpperCase() %>
                                                </div>
                                                <div>
                                                    <h6 class="mb-0 fw-bold text-dark"><%= student.name %></h6>
                                                    <small class="text-muted"><%= student.email %></small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-journal-text text-muted me-2"></i>
                                                <span class="fw-medium"><%= student.attempts %></span>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <% if (student.latestScore >= 80) { %>
                                                <span class="badge bg-success-subtle text-success rounded-pill px-3">Գերազանց</span>
                                            <% } else if (student.latestScore >= 50) { %>
                                                <span class="badge bg-warning-subtle text-warning rounded-pill px-3">Միջին</span>
                                            <% } else { %>
                                                <span class="badge bg-danger-subtle text-danger rounded-pill px-3">Ցածր</span>
                                            <% } %>
                                        </td>
                                        <td class="py-3">
                                            <div class="d-flex align-items-center">
                                                <% if (student.growth > 0) { %>
                                                    <i class="bi bi-graph-up-arrow text-success me-2"></i>
                                                    <span class="text-success fw-bold">+<%= student.growth.toFixed(1) %></span>
                                                <% } else if (student.growth < 0) { %>
                                                    <i class="bi bi-graph-down-arrow text-danger me-2"></i>
                                                    <span class="text-danger fw-bold"><%= student.growth.toFixed(1) %></span>
                                                <% } else { %>
                                                    <i class="bi bi-dash-lg text-muted me-2"></i>
                                                    <span class="text-muted">0</span>
                                                <% } %>
                                            </div>
                                        </td>
                                        <td class="py-3">
                                            <% if (student.status === 'improving') { %>
                                                <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-10 rounded-pill">
                                                    <i class="bi bi-arrow-up-right me-1"></i>Աճող
                                                </span>
                                            <% } else if (student.status === 'risk') { %>
                                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10 rounded-pill">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>Ռիսկային
                                                </span>
                                            <% } else { %>
                                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-10 rounded-pill">
                                                    <i class="bi bi-dash me-1"></i>Կայուն
                                                </span>
                                            <% } %>
                                        </td>
                                        <td class="py-3">
                                            <div class="form-check form-switch">
                                                <input class="form-check-input analytics-toggle" type="checkbox" role="switch" id="analyticsToggle<%= student.id %>" data-user-id="<%= student.id %>" <%= student.include_in_analytics ? 'checked' : '' %>>
                                            </div>
                                        </td>
                                        <td class="pe-4 py-3 text-end">
                                            <button class="btn btn-sm btn-light rounded-circle border" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                                                <i class="bi bi-chevron-down text-muted"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    <tr class="collapse bg-light" id="collapse<%= index %>">
                                        <td colspan="7" class="p-4">
                                            <div class="card border-0 shadow-sm rounded-4">
                                                <div class="card-body p-4">
                                                    <h6 class="fw-bold mb-4 text-secondary text-uppercase small ls-1">Առաջընթացի Ամփոփում</h6>
                                                    <div class="row g-4">
                                                        <!-- Test Growth -->
                                                        <div class="col-md-4">
                                                            <div class="p-3 rounded-4 bg-primary bg-opacity-10 h-100">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <div class="icon-square bg-white text-primary rounded-3 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                        <i class="bi bi-clipboard-check"></i>
                                                                    </div>
                                                                    <span class="text-muted small fw-bold text-uppercase">Թեստեր</span>
                                                                </div>
                                                                <div class="mt-3">
                                                                    <h3 class="fw-bold mb-0 <%= student.testGrowth > 0 ? 'text-success' : (student.testGrowth < 0 ? 'text-danger' : 'text-dark') %>">
                                                                        <%= student.testGrowth > 0 ? '+' : '' %><%= student.testGrowth ? student.testGrowth.toFixed(1) : '0' %>
                                                                    </h3>
                                                                    <small class="text-muted">Միջին աճ</small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Group Growth -->
                                                        <div class="col-md-4">
                                                            <div class="p-3 rounded-4 bg-info bg-opacity-10 h-100">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <div class="icon-square bg-white text-info rounded-3 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                        <i class="bi bi-collection"></i>
                                                                    </div>
                                                                    <span class="text-muted small fw-bold text-uppercase">Խմբեր</span>
                                                                </div>
                                                                <div class="mt-3">
                                                                    <h3 class="fw-bold mb-0 <%= student.groupGrowth > 0 ? 'text-success' : (student.groupGrowth < 0 ? 'text-danger' : 'text-dark') %>">
                                                                        <%= student.groupGrowth > 0 ? '+' : '' %><%= student.groupGrowth ? student.groupGrowth.toFixed(1) : '0' %>
                                                                    </h3>
                                                                    <small class="text-muted">Միջին աճ</small>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- Overall Activity -->
                                                        <div class="col-md-4">
                                                            <div class="p-3 rounded-4 bg-warning bg-opacity-10 h-100">
                                                                <div class="d-flex align-items-center mb-2">
                                                                    <div class="icon-square bg-white text-warning rounded-3 me-3 shadow-sm d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                                                        <i class="bi bi-activity"></i>
                                                                    </div>
                                                                    <span class="text-muted small fw-bold text-uppercase">Ընդհանուր</span>
                                                                </div>
                                                                <div class="mt-3">
                                                                    <div class="d-flex justify-content-between align-items-end">
                                                                        <div>
                                                                            <h3 class="fw-bold mb-0 text-dark"><%= student.attempts %></h3>
                                                                            <small class="text-muted">Ընդհանուր փորձ</small>
                                                                        </div>
                                                                        <div class="text-end">
                                                                            <span class="badge bg-white text-dark shadow-sm rounded-pill"><%= student.latestScore %> միավոր</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <% if (pagination.totalPages > 1) { %>
                        <div class="d-flex justify-content-center border-top p-3">
                            <nav aria-label="Page navigation">
                                <ul class="pagination pagination-sm mb-0">
                                    <li class="page-item <%= pagination.page === 1 ? 'disabled' : '' %>">
                                        <a class="page-link" href="<%= url %>?page=<%= pagination.page - 1 %>&search=<%= filters.search %>&status=<%= filters.status %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>" aria-label="Previous">
                                            <span aria-hidden="true">&laquo;</span>
                                        </a>
                                    </li>
                                    
                                    <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                        <li class="page-item <%= pagination.page === i ? 'active' : '' %>">
                                            <a class="page-link" href="<%= url %>?page=<%= i %>&search=<%= filters.search %>&status=<%= filters.status %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>"><%= i %></a>
                                        </li>
                                    <% } %>
                                    
                                    <li class="page-item <%= pagination.page === pagination.totalPages ? 'disabled' : '' %>">
                                        <a class="page-link" href="<%= url %>?page=<%= pagination.page + 1 %>&search=<%= filters.search %>&status=<%= filters.status %>&startDate=<%= filters.startDate %>&endDate=<%= filters.endDate %>" aria-label="Next">
                                            <span aria-hidden="true">&raquo;</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    <% } %>
                </div>
            </div>
        </section>
    </main>

    <%- include('../parts/scripts.ejs') %>

    <!-- Confirm Modal -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-bottom-0 pb-0">
                    <h5 class="modal-title fw-bold" id="confirmModalTitle">Հաստատում</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4" id="confirmModalBody">
                    Համոզվա՞ծ եք։
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-light rounded-pill px-4" id="confirmCancelBtn" data-bs-dismiss="modal">Չեղարկել</button>
                    <button type="button" class="btn btn-danger rounded-pill px-4" id="confirmOkBtn">Այո</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import Confirm from '/admin/js/confirm.js';

        document.addEventListener('DOMContentLoaded', () => {
            const confirmModal = new Confirm();
            const disableAllBtn = document.getElementById('disableAllAnalytics');

            if (disableAllBtn) {
                disableAllBtn.addEventListener('click', async () => {
                    const isConfirmed = await confirmModal.open({
                        title: 'Ուշադրություն',
                        message: 'Դուք պատրաստվում եք անջատել անալիտիկան ԲՈԼՈՐ ուսանողների համար։ Շարունակե՞լ։',
                        okText: 'Այո, անջատել',
                        cancelText: 'Չեղարկել',
                        okClass: 'btn-danger'
                    });

                    if (isConfirmed) {
                        try {
                            const response = await fetch('/admin/users/bulk-toggle-analytics', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ include: false })
                            });
                            const data = await response.json();
                            if (data.success) {
                                window.location.reload();
                            } else {
                                throw new Error('Failed');
                            }
                        } catch (e) {
                            alert('Սխալ տեղի ունեցավ');
                        }
                    }
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Data from Server
            const chartData = <%- JSON.stringify(chartData) %>;
            const kpi = <%- JSON.stringify(kpi) %>;

            // Growth Chart
            const ctxGrowth = document.getElementById('growthChart').getContext('2d');
            
            // Create gradient for improving
            const gradientImproving = ctxGrowth.createLinearGradient(0, 0, 0, 300);
            gradientImproving.addColorStop(0, 'rgba(25, 135, 84, 0.2)');
            gradientImproving.addColorStop(1, 'rgba(25, 135, 84, 0.0)');

            const growthChart = new Chart(ctxGrowth, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Բարելավվող',
                            data: chartData.improving,
                            borderColor: '#198754', // Success
                            backgroundColor: gradientImproving,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0, // Clean look
                            pointHoverRadius: 6,
                            fill: true,
                            spanGaps: true
                        },
                        {
                            label: 'Կայուն',
                            data: chartData.stagnant,
                            borderColor: '#ffc107', // Warning
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            fill: false,
                            borderDash: [5, 5],
                            spanGaps: true
                        },
                        {
                            label: 'Ռիսկային',
                            data: chartData.risk,
                            borderColor: '#dc3545', // Danger
                            backgroundColor: 'transparent',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 6,
                            fill: false,
                            spanGaps: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: { 
                            display: false // Hide default legend
                        },
                        tooltip: { 
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#000',
                            bodyColor: '#000',
                            borderColor: '#ddd',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { borderDash: [2, 4], color: '#f0f0f0' },
                            ticks: { padding: 10, color: '#999' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                maxTicksLimit: 10,
                                color: '#999'
                            }
                        }
                    }
                }
            });

            // Generate Custom Legend
            const legendContainer = document.getElementById('growthLegend');
            growthChart.data.datasets.forEach((dataset, index) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm rounded-pill d-flex align-items-center gap-2 border';
                btn.style.fontSize = '0.85rem';
                btn.style.backgroundColor = '#fff';
                btn.style.color = '#6c757d';
                
                // Color indicator
                const dot = document.createElement('span');
                dot.style.width = '10px';
                dot.style.height = '10px';
                dot.style.borderRadius = '50%';
                dot.style.backgroundColor = dataset.borderColor;
                dot.style.display = 'inline-block';
                
                btn.appendChild(dot);
                btn.appendChild(document.createTextNode(dataset.label));

                // Toggle function
                btn.onclick = () => {
                    const isHidden = !growthChart.isDatasetVisible(index);
                    growthChart.setDatasetVisibility(index, isHidden);
                    growthChart.update();
                    
                    // Update visual state
                    if (isHidden) {
                        btn.style.opacity = '1';
                        btn.classList.remove('text-decoration-line-through');
                    } else {
                        btn.style.opacity = '0.5';
                        btn.classList.add('text-decoration-line-through');
                    }
                };

                legendContainer.appendChild(btn);
            });

            // Status Donut Chart
            const ctxStatus = document.getElementById('statusChart').getContext('2d');
            new Chart(ctxStatus, {
                type: 'doughnut',
                data: {
                    labels: ['Բարելավվող', 'Կայուն', 'Ռիսկային'],
                    datasets: [{
                        data: [kpi.improving, kpi.stagnant, kpi.risk],
                        backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Analytics Toggle
            document.querySelectorAll('.analytics-toggle').forEach(toggle => {
                toggle.addEventListener('change', async function() {
                    const userId = this.getAttribute('data-user-id');
                    const include = this.checked;
                    
                    try {
                        const response = await fetch(`/admin/users/${userId}/toggle-analytics`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ include })
                        });
                        const data = await response.json();
                        if (!data.success) throw new Error('Toggle failed');
                    } catch (e) {
                        this.checked = !include; // Revert on error
                        alert('Սխալ տեղի ունեցավ: Կրկին փորձեք');
                    }
                });
            });

            // Server-side Search and Filter
            const searchInput = document.getElementById('studentSearch');
            const statusFilter = document.getElementById('statusFilter');

            const updateParams = () => {
                const search = searchInput.value;
                const status = statusFilter.value;
                const url = new URL(window.location.href);
                url.searchParams.set('search', search);
                url.searchParams.set('status', status);
                url.searchParams.set('page', 1); // Reset to page 1
                window.location.href = url.toString();
            };

            if(searchInput) {
                searchInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        updateParams();
                    }
                });
            }
            
            if(statusFilter) {
                statusFilter.addEventListener('change', updateParams);
            }
        });
    </script>
</body>
</html>